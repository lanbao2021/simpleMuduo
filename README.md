# simpleMuduo

A simplified Muduo network lib using C++ 11 features.

* [X] ç”¨C++ 11é‡å†™é™ˆç¡•çš„muduoç½‘ç»œåº“ï¼Œå»æ‰å¯¹Booståº“çš„ä¾èµ–
* [X] EchoServerå®ç°ã€è¿è¡Œ
* [ ] HTTP Serverå®ç°ã€è¿è¡Œ

# simpleMuduoç½‘ç»œåº“çš„è¿è¡ŒåŸç†

* [ ] å¦‚ä½•ç†è§£Reactorç½‘ç»œæ¨¡å‹ï¼Ÿ
* [ ] å„ä¸ªæ¨¡å—éƒ½æ˜¯å¹²å˜›çš„ï¼Ÿ
* [ ] ä¸€ä¸ªå®¢æˆ·è¿æ¥æ¥äº†åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ
* [ ] ä¸ºå•¥muduoç½‘ç»œåº“ä¸ä½¿ç”¨ETæ¨¡å¼ï¼Ÿå‡ºäºä»€ä¹ˆè€ƒé‡ï¼ŸğŸ˜§

# æ¨¡å—ç®€è¦ä»‹ç»

æŒ‰å¦‚ä¸‹é¡ºåºå»æ¢³ç†çš„è¯ä¼šæ¯”è¾ƒåˆé€‚

* [X] noncopyable
* [X] Logger
* [X] Timestamp
* [X] InetAddress
* [X] Channel
* [X] Poller
* [X] EpollPoller
* [ ] è·å–çº¿ç¨‹tid
* [ ] EventLoop
* [ ] Thread
* [ ] EventLoopThread
* [ ] Socket
* [ ] Acceptor
* [ ] TcpServer

## noncopyable

noncopyableè¢«ç»§æ‰¿ä»¥åï¼Œæ´¾ç”Ÿç±»å¯¹è±¡å¯ä»¥æ­£å¸¸çš„æ„é€ å’Œææ„ï¼Œä½†æ˜¯æ´¾ç”Ÿç±»å¯¹è±¡æ— æ³•è¿›è¡Œæ‹·è´æ„é€ å’Œèµ‹å€¼æ“ä½œ

è¿™æ˜¯é€šè¿‡ `= delete` å®ç°çš„

æœ‰ç‚¹åƒå•ä¾‹æ¨¡å¼ï¼Ÿæ„Ÿè§‰å°±æ˜¯å•Š

## Logger

muduoç½‘ç»œåº“é‡Œçš„æ—¥å¿—ç³»ç»Ÿå¹¶ä¸æ˜¯å¾ˆä¼˜ç§€

é‡‡ç”¨çš„æ˜¯åŒæ­¥çš„æ—¥å¿—ç³»ç»Ÿï¼Œå¯èƒ½ä¼šå­˜åœ¨æ€§èƒ½ç“¶é¢ˆ

å½“ç„¶ï¼Œåˆç†ä½¿ç”¨è°ƒè¯•å’Œæ—¥å¿—è¾“å‡ºå³å¯ï¼Œå½±å“ä¸ä¼šå¤ªå¤§

å®šä¹‰äº†å‡ ä¸ªå®æ¥å†™ä¸åŒçº§åˆ«çš„æ—¥å¿—ï¼š

* LOG_INFO
* LOG_ERROR
* LOG_FATAL
* LOG_DEBUG

## InetAddress

å°è£…äº†IPv4 socketåœ°å€ï¼Œè¿™ä¸ªæš‚æ—¶æ²¡æœ‰å¤ªå¤šå€¼å¾—è¯´é“çš„

## Channel

çœ‹åˆ°Channelå°±è¦å¼€å§‹å¤§è‡´ç†é¡ºä¸€ä¸‹è¿™ä¸ªç½‘ç»œåº“çš„æŠ½è±¡å±‚æ¬¡ç»“æ„äº†

å®ƒå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š

* TCPServer
  * EventLoop
    * PolleræŠ½è±¡ç±»(ç”¨äºå°è£…select, poll, epoll)
      * PollPoller
      * EPollPoller(ç›®å‰åªå®ç°äº†è¿™ä¸ª)
      * ChannelMap(ç®¡ç†å½“å‰Loopå…³å¿ƒçš„é‚£äº›Channelå¯¹è±¡)
        * `Channelmap<fd, Channel*>`
        * ChannelMapè®°å½•ç€sockfdåŠå…¶å¯¹åº”çš„Channelå¯¹è±¡
    * ChannelList activechannel_
      * ä¿å­˜æ´»è·ƒçš„channelsï¼Œäº¤ç»™äº‹ä»¶å¤„ç†ç¨‹åº
      * æ¯æ¬¡å¤„ç†å®Œæ¯•activechannel_éƒ½è¦ä»–éƒ½è¦clearä¸€ä¸‹
  * EventLoop
  * ...
  * EventLoop
  * å³One Thread Per Loop

å¯ä»¥çœ‹åˆ°ï¼ŒChannelç±»æ˜¯æ ¸å¿ƒçš„æŠ½è±¡æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥åº”è¯¥å…ˆææ‡‚å®ƒçš„å†…éƒ¨è®¾è®¡å†çœ‹å¤–éƒ¨ä½¿ç”¨å®ƒçš„é‚£äº›ç±»

## PolleræŠ½è±¡ç±»

å®ƒæ˜¯æŠ½è±¡ç±»ï¼Œç”¨æ¥è§„èŒƒæ´¾ç”Ÿç±»EPollPoller, PollPollerçš„è¡Œä¸º

âš ï¸æ³¨æ„ï¼šç›®å‰æˆ‘åªå®ç°äº†EPollPoller

## EPollPoller

å°è£…ç³»ç»Ÿè°ƒç”¨epoll_createæˆEPollPolleræ–¹æ³•

å°è£…ç³»ç»Ÿè°ƒç”¨epoll_ctlè¿›è¡Œadd/mod/delï¼Œå¯¹åº”updateChannel/removeChannel...æ–¹æ³•

å°è£…epoll_waitæˆpollæ–¹æ³•

é€šè¿‡ä»¥ä¸Šå°è£…å°±å¾ˆå¥½ç†è§£EPollPollerå¹²çš„äº‹æƒ…äº†ï¼Œç›‘å¬sockfdä¸Šçš„äº‹ä»¶ç„¶åæ›´æ–°ç›¸åº”çš„æ•°æ®ç»“æ„ï¼Œäº¤ç»™æ—¶é—´å¤„ç†å‡½æ•°EventHandler

## è·å–çº¿ç¨‹tid

å¦‚ä½•è·å–å½“å‰çº¿ç¨‹çš„tid?

è¯·æ³¨æ„ï¼šæ˜¯è·å–â€œçº¿ç¨‹tid"ä¸æ˜¯è¿›ç¨‹â€œpid"

`ps -ef | grep mysqld`è·å–çš„æ˜¯pid

## EventLoop

IOçº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹ä¹‹é—´å¹¶æ²¡æœ‰ä½¿ç”¨å¸¸è§çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼æ¥è¿›è¡Œä»»åŠ¡åˆ†å‘ï¼Œè€Œæ˜¯åŸºäºeventfdå’Œè½®è¯¢æœºåˆ¶æ¥å®ç°å”¤é†’å·¥ä½œçº¿ç¨‹å’Œåˆ†å‘ä»»åŠ¡ã€‚

### baseloopå’Œsubloopä¹‹é—´çš„é€šä¿¡æœºåˆ¶

EventLoopé‡Œé¢çš„runInLoopã€queueInLoopæ–¹æ³•ä¸€å¼€å§‹æŠŠæˆ‘ææ™•äº†

åœ¨runInLoopé‡Œé¢æœ‰è¿™ä¹ˆä¸€æ®µé€»è¾‘

```c++
    if (isInLoopThread()) // åœ¨å½“å‰çš„loopçº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œcb
    {
        cb();
    }
    else // åœ¨éå½“å‰loopçº¿ç¨‹ä¸­æ‰§è¡Œcb , å°±éœ€è¦å”¤é†’loopæ‰€åœ¨çº¿ç¨‹ï¼Œæ‰§è¡Œcb
    {
        queueInLoop(cb);
    }
```

é‚£ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°queueInLoop(cb)çš„æƒ…å†µå‘¢

TCPServerå¯¹è±¡é‡Œç®¡ç†äº†å¤šä¸ªloopå¯¹è±¡ï¼Œæ¯æ¬¡è½®è¯¢çš„é€‰ä¸€ä¸ªï¼Œæ¯ä¸ªloopå¯¹è±¡éƒ½å±äºä¸åŒçš„çº¿ç¨‹ï¼Œå‡è®¾TCPServerå¯¹åº”çš„é‚£ä¸€ä¸ªå«baseloopï¼Œé‚£ä¹ˆè¢«å®ƒé€‰å‡ºæ¥å¹²æ´»çš„å°±å«subloop

å…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹TcpServer::newConnectionæ–¹æ³•

* é¦–å…ˆå®ƒè½®è¯¢é€‰æ‹©ä¸€ä¸ªsubloopå¯¹è±¡ç”¨æ¥å¹²æ´»
* æ­¤æ—¶ä½ è¦æ„è¯†åˆ°ï¼Œèƒ½æ‰§è¡ŒnewConnectionæ–¹æ³•çš„æ˜¯baseloop
* ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¼šåœ¨baseloopé‡Œé¢æ‰§è¡Œsubloopçš„runInLoopæ–¹æ³•
* ç†è§£åˆ°è¿™ä¸€æ­¥å°±ç®—æ­£ç¡®ç†è§£äº†runInLoopå’ŒqueueInLoopçš„è®¾è®¡ç”¨æ„

é‚£ä¹ˆæ¥ä¸‹æ¥é—®é¢˜åˆæ¥äº†ï¼ŒqueueInLoopåbaseloopå¦‚ä½•é€šçŸ¥subloopå¹²æ´»å‘¢ï¼Œå› ä¸ºå…‰ç»™subloopæ·»åŠ å¾…æ‰§è¡Œçš„å›è°ƒå‡½æ•°å¹¶æ²¡æœ‰åŠæ³•è®©å®ƒæ‰§è¡Œï¼

è¿™å°±æ˜¯EventLoop::queueInLoopæ–¹æ³•é‡Œçš„wakeup()æ–¹æ³•çš„ä½œç”¨äº†ï¼Œä»–å¯ä»¥å¸®baseloopå”¤é†’subloopé‡Œé¢æ­£é˜»å¡åœ¨ï¼šâ¬‡ï¸

`poller_->poll(kPollTimeMs, &activeChannels_) `çš„ `EventLoop::loop`æ–¹æ³•

(æ³¨ï¼šä¸å–Šä»–èµ·åºŠwakeupä¹Ÿè¡Œï¼Œä½†æ˜¯è¦ç­‰ `kPollTimeMs`ç›´åˆ°å®ƒç¡é†’)

æ¯ä¸ªeventloopéƒ½ä¼šæœ‰ä¸€ä¸ªeventfdæ–‡ä»¶æè¿°ç¬¦ï¼Œæ¯ä¸ªeventloopä¹Ÿä¼šç›‘å¬è¿™ä¸ªeventfdæ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤wakeupå°±æ˜¯é€šè¿‡å¾€eventfdé‡Œéšä¾¿å†™ç‚¹ä¸œè¥¿ï¼Œç„¶åè®©é˜»å¡çš„Polleræ£€æµ‹åˆ°æœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿï¼Œç„¶åå°±ç«‹å³è¿”å›äº†

* è¿”å›åå…ˆç»è¿‡for (Channel *channel : activeChannels_)
  * å°±æ˜¯å°†eventfdçš„æ´»è·ƒçŠ¶æ€å»é™¤ï¼ŒæŠŠç¼“å†²åŒºçš„ä¸œè¥¿è¯»å‡ºæ¥å³å¯
* ç„¶åå†æ‰§è¡ŒdoPendingFunctors()ï¼Œå°±å®Œæˆäº†å›è°ƒä»»åŠ¡çš„æ‰§è¡Œ


## Thread

å°è£…äº†C++ 11çš„threadæ–¹æ³•

## EventLoopThread

ç®¡ç†ThreadåŠå…¶å¯¹åº”çš„EventLoop

One Loop Per Threadåœ¨è¿™ä¸ªç±»ä¸­å¾—åˆ°äº†å¾ˆå¥½çš„ä½“ç°

## EventLoopThreadPool

ç”¨äºç®¡ç†subloopåŠå…¶å¯¹åº”thread

baseloopä¸æ˜¯ç”¨EventLoopThreadPoolè¿›è¡Œåˆ›å»ºçš„

å¹¶ä¸”EventLoopThreadPoolè¿˜éš¶å±äºbaseloop

ï¼ˆçœ‹åˆ°åé¢çš„EchoServeræ¡ˆä¾‹ä¼šå‘ç°baseloopæ˜¯éœ€è¦å•ç‹¬åˆ›å»ºçš„ï¼‰

## Socket


## Acceptor

## TcpServer

## Buffer

## TcpConnection

# æµ‹è¯•æ¡ˆä¾‹ï¼šEchoServer


# å¤šReactor å¤šçº¿ç¨‹

è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜åç»­å†æ˜ç¡®ä¸€ä¸‹ï¼Œå°±æ˜¯SubReactoræ˜¯å¦ä¼šå°†ä¸šåŠ¡å¤„ç†äº¤ç»™WorkThread

![img](image/README/1694440902198.png)

è¿™ä¸ª[é¡¹ç›®](https://github.com/Shangyizhou/A-Tiny-Network-Library)é‡Œçš„ç¤ºæ„å›¾æ˜¯æœ‰ç”»çš„æ˜¯æœ‰å·¥ä½œçº¿ç¨‹æ± çš„

![img](https://camo.githubusercontent.com/43f02acdbd589ba7df40fdd0a7890a47314fc8d08e831f5f22c6f0414d0acd4d/68747470733a2f2f63646e2e6e6c61726b2e636f6d2f79757175652f302f323032322f706e672f32363735323037382f313637303835333133343532382d63383864323766322d313061322d343664332d623330382d3438663736333261326630392e706e673f782d6f73732d70726f636573733d696d616765253246726573697a65253243775f3933372532436c696d69745f30)

ä¸‹é¢è¿™ä¸ªå›¾å­˜ä¸€ä¸ªæ¡£ï¼Œæˆ‘è§‰å¾—ç”»çš„ä¸å¤ªè´´åˆmuduoç½‘ç»œåº“ï¼Œä½†æ˜¯æŠ½è±¡å±‚é¢ä¼¼ä¹æŒºæœ‰é€»è¾‘ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ”¹è¿›ä¸€ä¸‹ï¼Œç»“åˆmuduoç½‘ç»œåº“å…·ä½“çš„ç±»å†é‡åˆ¶ä¸€ä¸‹è¿™ä¸ªç»“æ„å›¾

![1698043411705](image/README/1698043411705.png)
